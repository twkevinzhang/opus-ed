# OpusED 需求分析與功能規格 (Final)

本文件定義了 `OpusED` 的核心功能規格，作為開發階段的真理之源。

## 1. 專案目標

現代化動畫主題曲 (OP/ED) 獲取工具，支援多來源 (YouTube/DMHY) 與批次處理流程。具備無狀態設計，預留未來擴展為 SaaS 服務的可行性。

## 2. 核心功能與工作流

### 2.1 批次任務初始化 (Batch Process)

- **多行輸入**：輸入動畫標題（一行一個）。
- **進階參數 (每趟執行)**：
  - **Bangumi.moe Token**：用於獲取歌曲元數據。
  - **下載資料夾**。
  - **優先影片來源** (YouTube 或 DMHY)。
  - **DMHY 模式選擇**：[預設進階] 直接下載影片 或 [簡易] 僅下載 .torrent 檔案。

### 2.2 預覽與編輯 (Preview & Edit)

- **資訊校對**：顯示從 Bangumi 獲取的歌曲名稱、歌手與搜尋結果預覽。
- **單筆編輯**：可手動修改單筆任務的搜尋關鍵字、切換來源、或個別下載路徑。

### 2.3 執行下載 (Download Execution)

- **YouTube Downloader**：使用 `yt-dlp` 進行影像/音訊提取。
- **DMHY Downloader**：
  - **模式 A (影片)**：整合協定直接下載影片檔案。
  - **模式 B (種子)**：僅將 `.torrent` 檔案存入目標目錄。
- **狀態回傳**：Sidecar 回傳即時下載進度與結果。

## 3. 技術設計 (職責分離)

### 3.1 Electron (Orchestrator)

- **業務邏輯**：負責 `BatchTask` 的初始化、驗證與生命週期管理。
- **資料持久化**：使用 JSON 格式存儲於使用者目錄下的 `tasks.json` 與 `history.json`。
- **狀態管理**：控制任務何時啟動、何時更新資訊。

### 3.2 Sidecar (Service Layer)

- **搜尋服務**：提供 Bangumi (API) 與 DMHY (Scraper) 的搜尋介面。
- **下載服務**：執行具體的下載任務 (yt-dlp / DMHY)。
- **無狀態設計**：不負責儲存任務清單，僅接受 Electron 的指令執行單筆任務。

## 4. 驗證計劃

- **TDD**：確保 Bangumi 元數據解析與 DMHY 搜尋邏輯的正確性。
- **模式切換測試**：驗證 DMHY 在「影片」與「種子」模式下的產出是否符合預期。
